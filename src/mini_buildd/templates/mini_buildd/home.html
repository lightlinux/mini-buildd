{% extends "mini_buildd/base.html" %}
{% load staticfiles %}
{% load mini_buildd_tags %}

{% block title %}mini-buildd{% endblock %}
{% block page_title %}{% mbd_title %}{% endblock %}
{% block page_sub_title %}
	{% if not daemon.is_busy %}
		{% if daemon.is_running %}
			{% mbd_api "stop" user show_more=False output="referer" %}
		{% else %}
			{% mbd_api "start" user show_more=False output="referer" %}
		{% endif %}
	{% endif %}
	{% mbd_api "logcat" user show_more=False %}
	<span class="status {% if daemon.is_busy %}busy{% elif daemon.is_running %}running{% else %}stopped{% endif %}">
		{% if daemon.is_busy %}Busy...{% elif daemon.is_running %}Running{% else %}Stopped{% endif %}: {{ daemon.model }}
	</span>
{% endblock %}
{% block mbd_page_footer %}
	{% mbd_api "getkey" user show_more=False name="Archive Key" %}: <kbd>{{ daemon.model.mbd_gnupg_long_id }}: {{ daemon.model.mbd_gnupg_fingerprint }}</kbd>
{% endblock %}

{% block content %}
	<div id="mbd_index_status">

		{% if not daemon.is_running %}
			{% mbd_api "autosetup" user %}
		{% endif %}

		<div id="mbd_index_repositories">
			<div class="box">
				<h1 class="box-caption">
					{% if daemon.packages.items %}<img src="{% static "img/progress_blue.gif" %}" alt="Packaging..." title="Packaging..." style="margin: -5px 0 -5px 0; padding: 0" />{% endif %}
					Packager: {{ daemon.packages|length }} packaging</h1>
					{% if daemon.packages.items %}
						{% mbd_packager_status daemon.packages.values %}
					{% endif %}

				<h2>Last packages: {{ daemon.last_packages|length }}
					(<a id="mbd-last-packages_header" href="javascript:mbdToggleElement('mbd-last-packages','mbd-last-packages_header','hide','show')" >show</a>)
				</h2>
				<div id="mbd-last-packages">
					{% if daemon.last_packages %}
						{% mbd_packager_status daemon.last_packages %}
					{% endif %}
				</div>

				<h2 title="Repositories in use">Repositories:</h2>
				<ul>
					{% for r in repositories %}
						<li>
							<span class="status {{ r.get_status_display }}" title="{{ r.mbd_get_status_display }}">{{ r }}</span>
							(<a title="Go to repository overview page" href="/mini_buildd/repositories/{{ r.identity }}/">Overview</a>)
							{% if r.external_home_url %}
								(<a href="{{ r.external_home_url }}" title="Link to the repository's external documentation">ExtHome</a>)
							{% endif %}
						</li>
					{% empty %}
						<li>No repositories.</li>
					{% endfor %}
				</ul>

				<h3 title="Extra functionality">Extras:
					{% mbd_api "portext" user show_more=True %}
					{% mbd_api "meta" user name="Keyring packages" title="(Re-)Build keyring packages for all active repositories" value_model="repository.Repository" value_function="build_keyring_packages" %}
					{% mbd_api "meta" user name="Test packages" title="(Re-)Build internal test packages for all active repositories" value_model="repository.Repository" value_function="build_test_packages" %}
				</h3>
			</div>
		</div>

		<div id="mbd_index_chroots">
			<div class="box">
				<h1 class="box-caption">
					{% if daemon.builds.items %}<img src="{% static "img/progress_blue.gif" %}" alt="Building..." title="Building..." style="margin: -5px 0 -5px 0; padding: 0" />{% endif %}
					Builder: {{ daemon.build_queue }} building
				</h1>
				{% if daemon.builds.items %}
					{% mbd_builder_status daemon.builds.values %}
				{% endif %}

				<h2>Last builds: {{ daemon.last_builds|length }}
					(<a id="mbd-last-builds_header" href="javascript:mbdToggleElement('mbd-last-builds','mbd-last-builds_header','hide','show')" >show</a>)
				</h2>
				<div id="mbd-last-builds">
					{% if daemon.last_builds %}
						{% mbd_builder_status daemon.last_builds %}
					{% endif %}
				</div>

				<h2 title="Chroots in use">Chroots:</h2>
				<ul>
					{% for c in chroots %}
						<li><span class="status {{ c.get_status_display }}" title="{{ c.mbd_get_status_display }}">{{ c }}</span></li>
					{% empty %}
						<li>No chroots.</li>
					{% endfor %}
				</ul>
			</div>
		</div>

		<div id="mbd_index_remotes">
			<div class="box">
				<h1 class="box-caption">Network: {{ remotes|length }} remotes</h1>
				<h2 title="Remotes in use">Remotes:</h2>
				<ul>
					{% for r in remotes %}
						<li>
							<span class="status {{ r.get_status_display }}" title="{{ r.mbd_get_status_display }}">{{ r }}</span>
							(<a title="Visit remote" href="http://{{ r.http }}/">Visit</a>)
						</li>
					{% empty %}
						<li>No remotes.</li>
					{% endfor %}
				</ul>
			</div>
		</div>
	</div>
{% endblock %}
